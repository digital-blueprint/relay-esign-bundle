<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .center {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        flex-direction: column;
      }
      .center div {
        padding: 10px;
        text-align: center;
        line-height: 2em;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        font-size: 20px;
      }
      #code {
        background-color: #eee;
        padding: 4px;
        word-break: break-all;
      }
    </style>
  </head>

  <body>
    <div class="center">
      <div>Code: <span id="code">-</span></div>
      <div>
        <input
          type="button"
          value="Copy Code to Clipboard"
          id="copy"
          disabled
        />
      </div>
    </div>
  </body>

  <script type="module">
    function getSessionId(href) {
      let url;
      try {
        url = new URL(href);
      } catch {
        return null;
      }
      const pdfurl = url.searchParams.get("pdfurl");
      if (pdfurl === null) {
        return null;
      }
      let parserPdfUrl;
      try {
        parserPdfUrl = new URL(decodeURIComponent(pdfurl));
      } catch {
        return null;
      }
      const match = parserPdfUrl.pathname.match(/;jsessionid=([^?#;/]+)/i);
      return match ? decodeURIComponent(match[1]) : null;
    }

    function getToken(href) {
      let url;
      try {
        url = new URL(href);
      } catch {
        return null;
      }
      return url.searchParams.get('token');
    }

    function buildMessage(href) {
      const sessionId = getSessionId(href);
      const token = getToken(href);
      if (sessionId === null && token === null) {
        return {
          type: "pdf-as-error",
          cause: "",
          error: "Failed to extract the session ID",
        };
      }
      return { type: "pdf-as-callback", sessionId: sessionId, token: token }
    }

    function postToParent(message) {
      window.parent.postMessage(message, "*");
      console.log("Callback - PostMessage Data:", message);
    }

    function getCode(message) {
      if (message['type'] === "pdf-as-callback") {
        return message.sessionId ?? message.token;
      }
      return null;
    }

    function showOnPage(message) {
      let element = document.getElementById("code");
      let button = document.getElementById("copy");
      let code = getCode(message);
      element.textContent = code ?? '-';
      if (code !== null) {
        button.disabled = false;
        button.onclick = () => { navigator.clipboard.writeText(code); };
      }
    }

    function main() {
      let href = window.location.href
      console.log("Callback - URL: " + href);
      const message = buildMessage(href);
      postToParent(message);
      showOnPage(message);
    }

    function test() {
      console.assert('357873A48F30D0FFE6ABF1BF758742D7' === getSessionId('http://example.com/callback.html?pdfurl=https%253A%252F%252Fsig-dev.tugraz.at%252Fpdf-as-web%252FPDFData%253Bjsessionid%253D357873A48F30D0FFE6ABF1BF758742D7&pdflength=206242'));
      console.assert(null === getSessionId('http://example.com'));
      console.assert(null === getSessionId('http://example.com?pdfurl=nope'));
      console.assert(null === getSessionId('http://example.com?pdfurl=nope;bla'));
      console.assert(null === getSessionId('http://example.com?pdfurl=https%3A%2F%2Ffoo.bar'));
      console.assert('42' === getSessionId('http://example.com?pdfurl=https%3A%2F%2Ffoo.bar%2Ffoo%3Bjsessionid%3D42'));
      console.assert('+' === getSessionId('http://example.com?pdfurl=https%3A%2F%2Ffoo.bar%2Ffoo%3Bjsessionid%3D%252B'));
      console.assert('24af0e51-744d-4f7c-9404-a2376c7d4918' === getToken('http://localhost:8000/esign/_success?reqId=b46e4962-9b17-4f44-903d-1a0ec1f92da2&token=24af0e51-744d-4f7c-9404-a2376c7d4918'));
      console.assert(null === getToken('http://example.com'));
      console.assert(' ' === getToken('http://example.com?token=%20'));
      console.assert(buildMessage('http://example.com')['type'] === 'pdf-as-error');
      console.assert(buildMessage('')['type'] === 'pdf-as-error');
      console.assert(buildMessage('http://example.com?token=foo')['type'] === 'pdf-as-callback');
      console.assert(buildMessage('http://example.com?token=foo')['token'] === 'foo');
      console.assert(buildMessage('http://example.com?token=foo&pdfurl=https%3A%2F%2Ffoo.bar%2Ffoo%3Bjsessionid%3D%252B')['token'] === 'foo');
      console.assert(buildMessage('http://example.com?token=foo&pdfurl=https%3A%2F%2Ffoo.bar%2Ffoo%3Bjsessionid%3D%252B')['sessionId'] === '+');
    }

    main();
    window.test = test;
  </script>
</html>
